#!/usr/bin/env ruby
$stdout.sync = true

require 'shellwords'
require 'json'

ENV['RAILS_ENV'] ||= 'development'
RAILS_ENV   = ENV['RAILS_ENV']

ENV['NODE_ENV'] ||= RAILS_ENV
NODE_ENV    = ENV['NODE_ENV']

APP_PATH = File.expand_path('../', __dir__)
ESCAPED_APP_PATH = APP_PATH.shellescape

config = begin
  package_json = File.read(File.join(APP_PATH, 'package.json'))
  JSON.parse(package_json)['config']
rescue Errno::ENOENT
  puts 'Package.json not found. Have you installed webpacker?'
  puts 'Please run bundle exec rails webpacker:install to install webpacker'
end

NODE_MODULES_PATH = "#{File.join(ESCAPED_APP_PATH, config['webpacker']['nodeModulesDir'])}"
WEBPACK_CONFIG_PATH = "#{File.join(ESCAPED_APP_PATH, config['webpacker']['configDir'])}"

WEBPACK_BIN  = "#{NODE_MODULES_PATH}/.bin/webpack"
WEBPACK_CONFIG = "#{WEBPACK_CONFIG_PATH}/#{NODE_ENV}.js"

Dir.chdir(APP_PATH) do
  exec "NODE_PATH=#{NODE_MODULES_PATH} #{WEBPACK_BIN} --config #{WEBPACK_CONFIG}" \
  " #{ARGV.join(" ")}"
end
